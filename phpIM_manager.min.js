/*! phpIM 27-05-2013 */
var new_conversations_manager=function(e,n){e=e||{},n=n||{};var s=new_base_messenger(e,n),o=e.ajax||$.ajax,t=[],i={},a=function(){return!1},c=function(){console.log("Update Url : "+n.build_update_url(t)),t.length>0?o(n.ajax_fig({url:n.build_update_url(t),type:"GET",success:function(e){console.log("UPDATE RESPONSE : "+JSON.stringify(e)+"\n");var s,o,a,r;for(s in e)r=e[s][e[s].length-1],i[s]&&r&&(i[s].last_id=r.id);for(o=t.length-1;o>=0;o-=1)a=t[o].id,a&&i[a]?t[o].last_id=i[a].last_id:i[a]||t.splice(o,1);n.isConnected&&c()}})):n.isConnected&&(console.log("No Joined Conversations, No Update.\n"),setTimeout(function(){c()},MANAGER_CHECK_JOINED_TIMEOUT))};return mixin_observer_publisher(s),s.connect=function(){n.isConnected||(n.isConnected=!0,c())},s.disconnect=function(){n.isConnected=!1},s.conversations_data=function(){return JSON.parse(JSON.stringify(i))},s.joined_conversations=function(){return JSON.parse(JSON.stringify(t))},s.get_available_conversations=function(){o(n.ajax_fig({url:ROOT+"conversations/live",type:"GET",success:function(e){var n;for(i={},n=0;e.length>n;n+=1)i[e[n].id]=e[n];console.log("Available Conversations : "+JSON.stringify(i)+"\n")}}))},s.join_conversation=function(e){var n=JSON.parse(JSON.stringify(i[e]));!a(e)&&n&&(n.id=e,t.push(n)),console.log("Joined Conversations : "+JSON.stringify(t)+"\n")},s.send_message=function(e){var s;n.isConnected&&!n.isMessagePending?(console.log("Message Sending\n"),n.messageQueue.length>0?(n.messageQueue.push(e),s=n.messageQueue):s=e,n.messageQueue=[],n.isMessagePending=!0,o(n.ajax_fig({url:ROOT+"conversations/messages",type:"POST",data:s,success:function(e){lastId=e.id,n.isMessagePending=!1,console.log("Message Response : "+JSON.stringify(e)+"\n")}}))):(console.log("Could Not send Message\n"),n.messageQueue.push(e))},s},conversationsManager=new_conversations_manager();conversationsManager.connect(),$(document).ready(function(){$("#get-available-conversations").click(function(){conversationsManager.get_available_conversations()}),$("#join-conversation").click(function(){var e=$("#conversation-id").val();conversationsManager.get_available_conversations(),conversationsManager.join_conversation(e)})});