/*! phpIM 17-05-2013 */
var new_conversations_manager=function(e){e=e||{};var n={},s=e.ajax||$.ajax,o=[],t={},i=!1,c=[],r=function(e){var n,s={cache:!1,timeout:AJAX_TIMEOUT_MILLISECONDS,dataType:AJAX_DATA_TYPE,error:function(e,n,s){console.log("ERROR #"+numErrors+" : "+n+" : "+s)},complete:function(e,n){console.log("COMPLETE : "+n)}};for(n in e)s[n]=e[n];return s},a=function(){return!1},u=function(){var e,n=ROOT+"conversations/updates";for(e=0;o.length>e;e+=1)n+="/"+(o[e].id||"null")+","+(o[e].last_id||"null");return n},g=function(){o.length>0?s(r({url:u(),type:"GET",success:function(e){console.log("UPDATE RESPONSE : "+JSON.stringify(e)),i&&g()}})):setTimeout(function(){g()},1e3)};return mixin_observer_publisher(n),n.connect=function(){i||(i=!0,g())},n.disconnect=function(){i=!1},n.conversations_data=function(){return JSON.parse(JSON.stringify(t))},n.joined_conversations=function(){return JSON.parse(JSON.stringify(o))},n.get_available_conversations=function(){s(r({url:ROOT+"conversations/live",type:"GET",success:function(e){console.log("UPDATE RESPONSE : "+JSON.stringify(e));var n;for(n=0;e.length>n;n+=1)t[e[n].id]=e[n],delete e[n].id}}))},n.join_conversation=function(e){!a(e)&&t[e]&&(t[e].id=e,o.push(t[e]),delete t[e])},n.send_message=function(e,n){var o;i&&n&&!isMessagePending?(console.log("Message Sending"),c.length>0?(c.push(e),o=c):o=e,c=[],isMessagePending=!0,s(r({url:ROOT+"conversations/"+n+"/messages",type:"POST",data:o,success:function(e){lastId=e.id,isMessagePending=!1,console.log("MESSAGE RESPONSE : "+JSON.stringify(e))}}))):(console.log("Could Not send Message"),c.push(e))},n},conversationsManager=new_conversations_manager();$(document).ready(function(){$("#get-available-conversations").click(function(){conversationsManager.get_available_conversations()})});