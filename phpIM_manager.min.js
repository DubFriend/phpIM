/*! phpIM 06-07-2013 */
var AJAX_DATA_TYPE="json",AJAX_TIMEOUT_MILLISECONDS=6e4,ROOT="/phpIM/index.php/",MANAGER_CHECK_JOINED_TIMEOUT=1e4;"function"!=typeof Object.prototype.create&&(Object.create=function(e){var n=function(){};return n.prototype=e,new n});var is_array=function(e){return"[object Array]"===Object.prototype.toString.call(e)},array_last=function(e){if(is_array(e))return e.length>0?e[e.length-1]:void 0;throw"not an array"},object_values=function(e){var n,s=[];for(n in e)e.hasOwnProperty(n)&&s.push(e[n]);return s},mixin_observer_publisher=function(e){var n=[];return e.subscribe=function(e){n.push(e)},e.unsubscribe=function(e){var s;for(s=0;n.length>s;s+=1)if(n[s]===e)return n.splice(s,1),!0;return!1},e.publish=function(e){var s;for(s=0;n.length>s;s+=1)n[s].update(e)},e},new_base_messenger=function(e,n){var s={};return n.isConnected=!1,n.messageQueue=[],n.isMessagePending=!1,n.updateTimeoutTime=e.updateTimeoutTime||0,n.ajax_fig=function(a){var t,o={cache:!1,timeout:AJAX_TIMEOUT_MILLISECONDS,dataType:AJAX_DATA_TYPE,error:function(){var s=0,a=e.maxErrors||3;return function(e,t,o){console.log("ERROR #"+s+" : "+t+" : "+o+"\n"),s+=1,s>a&&(n.isConnected=!1)}}(),complete:function(e,a){console.log("COMPLETE : "+a+"\n"),n.messageQueue.length>0&&s.send(n.messageQueue)}};for(t in a)o[t]=a[t];return o},n.build_update_url=function(e){return ROOT+"conversations/updates/"+JSON.stringify(e)},s},new_messenger_view=function(){var e={},n='<h3>{{conversationId}}</h3>{{#messages}}<div class="message"><p>{{message}}</p><p>{{id}}</p><p>{{time_stamp}}</p></div>{{/messages}}';return e.update=function(e){console.log("View Data : "+JSON.stringify(e));var s,a=e.messages;if(a)for(s in a)a[s]instanceof Array&&$("#phpIM-message-area").append(Mustache.render(n,{conversationId:s,messages:a[s]}))},e},new_chatbox_view=function(){var e={},n="<div id='phpIM-conversation-{{id}}'><h3>Conversation with {{username}}</h3><div class='phpIM-message-area well'></div><form class='phpIM-send-message'><fieldset><div><textarea name='message' placeholder='Your message here.'></textarea></div><input type='submit' class='btn btn-primary' value='Send'/></fieldset></form></div>",s="{{#messages}}<div class='phpIM-message'><p class='message'><b>{{username}} </b>{{message}}<span class='time-stamp'>{{time_stamp}}</span></p></div>{{/messages}}",a='{{#available}}<div class="phpIM-available"><p>id : {{id}}</p><p>username : {{username}}</p><p>last_update_check : {{last_update_check}}</p><button id="phpIM-join-{{id}}" class="btn btn-info">Join</button></div>{{/available}}';return render_conversation=function(e){console.log("Chatbox Id : "+JSON.stringify(e)),$("#phpIM-conversations").append(Mustache.render(n,e))},render_messages=function(e,n){console.log("Messages Data : id : "+e+" : messages : "+JSON.stringify(n));var a=$("#phpIM-conversation-"+e+" .phpIM-message-area");a.append(Mustache.render(s,{messages:n})),a.scrollTop(a.prop("scrollHeight"))},render_available=function(e){console.log("Available Data : "+JSON.stringify(e)),$("#phpIM-available").html(Mustache.render(a,{available:e}))},e.update=function(e){if(console.log("Chatbox View Data : "+JSON.stringify(e)),e.newConversation&&render_conversation(e.newConversation),e.messages&&e.messages instanceof Object){var n;for(n in e.messages)e.messages[n]instanceof Array?render_messages(n,e.messages[n]):console.log("Update Message Data : "+JSON.stringify(e.messages[n]))}e.availableConversations&&render_available(object_values(e.availableConversations)),e.username&&$("#username-label").html(e.username)},e},new_conversations_controller=function(e){var n,s=mixin_observer_publisher({}),a=e.conversationsManager,t=function(e){return{conversation_id:e,message:$("#phpIM-conversation-"+e+' [name="message"]').val(),username:n}},o=function(e){console.log("Bind Conversation id : "+e),$("#phpIM-conversation-"+e+" form.phpIM-send-message").submit(function(n){n.preventDefault(),a.send_message(t(e))})};return s.init=function(){$("#get-available-conversations").click(function(e){e.preventDefault(),a.get_available_conversations()}),$("#phpIM-set-username").click(function(e){e.preventDefault(),n=$("#phpIM-username").val(),s.publish({username:n})}),$("#phpIM-start-conversation").click(function(e){e.preventDefault(),n?a.start_conversation({username:n}):alert("you must set your username.")})},s.update=function(e){if(e.availableConversations){var s,t=object_values(e.availableConversations);for(s=0;t.length>s;s+=1)(function(e){var s=t[e].id;$("#phpIM-join-"+s).click(function(){n?a.join_conversation(s):alert("you must set your username."),o(s)})})(s)}},s},new_conversations_manager=function(e,n){e=e||{},n=n||{};var s=new_base_messenger(e,n),a=e.ajax||$.ajax,t=[],o={},i=function(){return!1},r=function(){console.log("Update Url : "+n.build_update_url(t)),t.length>0?a(n.ajax_fig({url:n.build_update_url(t),type:"GET",success:function(e){console.log("UPDATE RESPONSE : "+JSON.stringify(e)+"\n"),s.publish({messages:e});var a,i,c,u;for(a in e)u=e[a][e[a].length-1],o[a]&&u&&(o[a].last_id=u.id);for(i=t.length-1;i>=0;i-=1)c=t[i].id,c&&o[c]?t[i].last_id=o[c].last_id:o[c]||t.splice(i,1);n.isConnected&&r()}})):n.isConnected&&(console.log("No Joined Conversations, No Update.\n"),setTimeout(function(){r()},MANAGER_CHECK_JOINED_TIMEOUT))};return mixin_observer_publisher(s),s.connect=function(){n.isConnected||(n.isConnected=!0,r())},s.disconnect=function(){n.isConnected=!1},s.conversations_data=function(){return JSON.parse(JSON.stringify(o))},s.joined_conversations=function(){return JSON.parse(JSON.stringify(t))},s.get_available_conversations=function(){a(n.ajax_fig({url:ROOT+"conversations/live",type:"GET",success:function(e){var n;for(o={},n=0;e.length>n;n+=1)o[e[n].id]=e[n];s.publish({availableConversations:o}),console.log("Available Conversations : "+JSON.stringify(o)+"\n")}}))},s.start_conversation=function(e){a(n.ajax_fig({url:ROOT+"conversations",type:"POST",data:e,success:function(e){console.log("Connect Response : "+JSON.stringify(e)+"\n"),s.get_available_conversations()}}))},s.join_conversation=function(e){var n=JSON.parse(JSON.stringify(o[e]));!i(e)&&n&&(n.id=e,t.push(n),s.publish({newConversation:n})),console.log("Joined Conversations : "+JSON.stringify(t)+"\n")},s.send_message=function(e){var s;n.isConnected&&!n.isMessagePending?(console.log("Message Sending\n"),n.messageQueue.length>0?(n.messageQueue.push(e),s=n.messageQueue):s=[e],n.messageQueue=[],n.isMessagePending=!0,a(n.ajax_fig({url:ROOT+"conversations/messages",type:"POST",data:{messages:s},success:function(e){lastId=e.id,n.isMessagePending=!1,console.log("Message Response : "+JSON.stringify(e)+"\n")}}))):(console.log("Could Not send Message\n"),n.messageQueue.push(e))},s},conversationsManager=new_conversations_manager(),messengerView=new_messenger_view(),chatView=new_chatbox_view(),conversationsController=new_conversations_controller({conversationsManager:conversationsManager});conversationsManager.subscribe(chatView),conversationsManager.subscribe(conversationsController),conversationsController.subscribe(chatView),conversationsManager.connect(),$(document).ready(function(){conversationsController.init()});