/*! phpIM 17-05-2013 */
var new_conversations_manager=function(e){e=e||{};var n={},s=e.ajax||$.ajax,t=[],o={},i=!1,a=[],c=function(e){var n,s={cache:!1,timeout:AJAX_TIMEOUT_MILLISECONDS,dataType:AJAX_DATA_TYPE,error:function(e,n,s){console.log("ERROR #"+numErrors+" : "+n+" : "+s)},complete:function(e,n){console.log("COMPLETE : "+n)}};for(n in e)s[n]=e[n];return s},r=function(){return!1},u=function(){var e,n=ROOT+"conversations/updates";for(e=0;t.length>e;e+=1)n+="/"+(t[e].id||"null")+","+(t[e].last_id||"null");return n},g=function(){t.length>0?s(c({url:u(),type:"GET",success:function(e){console.log("UPDATE RESPONSE : "+JSON.stringify(e)),i&&g()}})):setTimeout(function(){g()},1e3)};return mixin_observer_publisher(n),n.connect=function(){i||(i=!0,g())},n.disconnect=function(){i=!1},n.conversations_data=function(){return JSON.parse(JSON.stringify(o))},n.joined_conversations=function(){return JSON.parse(JSON.stringify(t))},n.get_available_conversations=function(){s(c({url:ROOT+"conversations/live",type:"GET",success:function(e){console.log("UPDATE RESPONSE : "+JSON.stringify(e));var n;for(n=0;e.length>n;n+=1)o[e[n].id]=e[n],delete e[n].id}}))},n.join_conversation=function(e){!r(e)&&o[e]&&(o[e].id=e,t.push(o[e]),delete o[e])},n.send_message=function(e){var n;i&&!isMessagePending?(console.log("Message Sending"),a.length>0?(a.push(e),n=a):n=e,a=[],isMessagePending=!0,s(c({url:ROOT+"conversations/"+e.conversationId+"/messages",type:"POST",data:n,success:function(e){lastId=e.id,isMessagePending=!1,console.log("MESSAGE RESPONSE : "+JSON.stringify(e))}}))):(console.log("Could Not send Message"),a.push(e))},n},conversationsManager=new_conversations_manager();$(document).ready(function(){$("#get-available-conversations").click(function(){conversationsManager.get_available_conversations()})});