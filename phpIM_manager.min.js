/*! phpIM 28-05-2013 */
var AJAX_DATA_TYPE="json",AJAX_TIMEOUT_MILLISECONDS=6e4,ROOT="/phpIM/index.php/",MANAGER_CHECK_JOINED_TIMEOUT=1e4;"function"!=typeof Object.prototype.create&&(Object.create=function(e){var n=function(){};return n.prototype=e,new n});var mixin_observer_publisher=function(e){var n=[];return e.subscribe=function(e){n.push(e)},e.unsubscribe=function(e){var s;for(s=0;n.length>s;s+=1)if(n[s]===e)return n.splice(s,1),!0;return!1},e.publish=function(e){var s;for(s=0;n.length>s;s+=1)n[s].update(e)},e},new_base_messenger=function(e,n){var s={};return n.isConnected=!1,n.messageQueue=[],n.isMessagePending=!1,n.updateTimeoutTime=e.updateTimeoutTime||0,n.ajax_fig=function(t){var o,a={cache:!1,timeout:AJAX_TIMEOUT_MILLISECONDS,dataType:AJAX_DATA_TYPE,error:function(){var s=0,t=e.maxErrors||3;return function(e,o,a){console.log("ERROR #"+s+" : "+o+" : "+a+"\n"),s+=1,s>t&&(n.isConnected=!1)}}(),complete:function(e,t){console.log("COMPLETE : "+t+"\n"),n.messageQueue.length>0&&s.send(n.messageQueue)}};for(o in t)a[o]=t[o];return a},n.build_update_url=function(e){return ROOT+"conversations/updates/"+JSON.stringify(e)},s},new_messenger_view=function(){var e={},n='<h3>{{conversationId}}</h3>{{#messages}}<div class="message"><p>{{message}}</p><p>{{id}}</p><p>{{time_stamp}}</p></div>{{/messages}}';return e.update=function(e){console.log("View Data : "+JSON.stringify(e));var s,t=e.messages;if(t)for(s in t)t[s]instanceof Array&&$("#phpIM-message-area").append(Mustache.render(n,{conversationId:s,messages:t[s]}))},e},new_chatbox_view=function(){var e={},n="<div id='phpIM-conversation-{{conversationId}}'><div class='phpIM-message-area'></div><h3>{{conversationId}}</h3><form class='phpIM-send-message'><textarea name='message' placeholder='message'></textarea><input type='submit' value='send'/></form></div>";return e.render=function(e){console.log("Chatbox View Data : "+JSON.stringify(data)),$("#phpIM-conversations").append(Mustache.render(n,{conversationId:e}))},e.update=function(e){console.log("Chatbox View Data : "+JSON.stringify(e));var s;e.newConversation&&(s=e.newConversation.id,$("#phpIM-conversations").append(Mustache.render(n,{conversationId:s})))},e},new_conversations_controller=function(){var e={};return e.update=function(e){console.log("Chatbox Controller Data : "+JSON.stringify(e)),e.newConversation&&e.newConversation.id},e},new_conversations_manager=function(e,n){e=e||{},n=n||{};var s=new_base_messenger(e,n),t=e.ajax||$.ajax,o=[],a={},i=function(){return!1},r=function(){console.log("Update Url : "+n.build_update_url(o)),o.length>0?t(n.ajax_fig({url:n.build_update_url(o),type:"GET",success:function(e){console.log("UPDATE RESPONSE : "+JSON.stringify(e)+"\n"),s.publish({messages:e});var t,i,c,u;for(t in e)u=e[t][e[t].length-1],a[t]&&u&&(a[t].last_id=u.id);for(i=o.length-1;i>=0;i-=1)c=o[i].id,c&&a[c]?o[i].last_id=a[c].last_id:a[c]||o.splice(i,1);n.isConnected&&r()}})):n.isConnected&&(console.log("No Joined Conversations, No Update.\n"),setTimeout(function(){r()},MANAGER_CHECK_JOINED_TIMEOUT))};return mixin_observer_publisher(s),s.connect=function(){n.isConnected||(n.isConnected=!0,r())},s.disconnect=function(){n.isConnected=!1},s.conversations_data=function(){return JSON.parse(JSON.stringify(a))},s.joined_conversations=function(){return JSON.parse(JSON.stringify(o))},s.get_available_conversations=function(){t(n.ajax_fig({url:ROOT+"conversations/live",type:"GET",success:function(e){var n;for(a={},n=0;e.length>n;n+=1)a[e[n].id]=e[n];console.log("Available Conversations : "+JSON.stringify(a)+"\n")}}))},s.join_conversation=function(e){var n=JSON.parse(JSON.stringify(a[e]));!i(e)&&n&&(s.publish({newConversation:{id:e}}),n.id=e,o.push(n)),console.log("Joined Conversations : "+JSON.stringify(o)+"\n")},s.send_message=function(e){var s;n.isConnected&&!n.isMessagePending?(console.log("Message Sending\n"),n.messageQueue.length>0?(n.messageQueue.push(e),s=n.messageQueue):s=e,n.messageQueue=[],n.isMessagePending=!0,t(n.ajax_fig({url:ROOT+"conversations/messages",type:"POST",data:s,success:function(e){lastId=e.id,n.isMessagePending=!1,console.log("Message Response : "+JSON.stringify(e)+"\n")}}))):(console.log("Could Not send Message\n"),n.messageQueue.push(e))},s},conversationsManager=new_conversations_manager(),messengerView=new_messenger_view(),chatView=new_chatbox_view();conversationsManager.subscribe(chatView),conversationsManager.connect(),$(document).ready(function(){$("#get-available-conversations").click(function(){conversationsManager.get_available_conversations()}),$("#join-conversation").click(function(){var e=$("#conversation-id").val();conversationsManager.get_available_conversations(),conversationsManager.join_conversation(e)})});