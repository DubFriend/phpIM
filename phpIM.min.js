/*! phpIM 12-05-2013 */
var AJAX_DATA_TYPE="json",AJAX_TIMEOUT_MILLISECONDS=6e4,ROOT="/phpIM/index.php/";"function"!=typeof Object.prototype.create&&(Object.create=function(e){var n=function(){};return n.prototype=e,new n});var new_messenger=function(e){e=e||{};var n,s,t={},o=e.ajax||$.ajax,c=[],a=!1,i=!1,r=0,u=e.maxErrors||3,g=e.updateTimeoutTime||0,p=function(e){var n,s={cache:!1,timeout:AJAX_TIMEOUT_MILLISECONDS,dataType:AJAX_DATA_TYPE,error:function(e,n,s){console.log("ERROR #"+r+" : "+n+" : "+s),r+=1,r>u&&(a=!1)},complete:function(e,n){console.log("COMPLETE : "+n),isMessageSendPending=!1,c.length>0&&t.send(c)}};for(n in e)s[n]=e[n];return s},d=function(){if(a){var e;e=s?ROOT+"conversations/"+n+"/messages_since/"+s:ROOT+"conversations/"+n,o(p({url:e,type:"GET",success:function(e){console.log("UPDATE RESPONSE : "+JSON.stringify(e)),g>0?setTimeout(d,g):d()},complete:void 0}))}};return t.is_connected=function(){return a},t.is_message_pending=function(){return i},t.message_queue_length=function(){return c.length},t.id=function(){return n},t.connect=function(e){a=!0,o(p({url:ROOT+"conversations",type:"POST",data:e,success:function(e){console.log("CONNECT RESPONSE : "+JSON.stringify(e)),n=e.id,d()}}))},t.disconnect=function(){a=!1},t.send_message=function(e){var t;a&&n&&!i?(console.log("Message Sending"),c.length>0?(c.push(e),t=c):t=e,c=[],i=!0,o(p({url:ROOT+"conversations/"+n+"/messages",type:"POST",data:t,success:function(e){s=e.id,i=!1,console.log("MESSAGE RESPONSE : "+JSON.stringify(e))}}))):(console.log("Could Not send Message"),c.push(e))},t},get_message_data=function(){return{message:$('#phpIM-send-message [name="message"]').val()}},get_connect_data=function(){return{username:$('phpIM-connect [name="username"]').val()}},append_message=function(e){$("#phpIM-message-area").append("<p>"+JSON.stringify(e)+"</p>")},messenger=new_messenger();$(document).ready(function(){$("#phpIM-disconnect").click(function(e){e.preventDefault(),console.log("Disconnect"),messenger.disconnect()}),$("#phpIM-connect").submit(function(e){e.preventDefault(),messenger.connect(get_connect_data())}),$("#phpIM-send-message").submit(function(e){e.preventDefault(),messenger.is_connected()?(console.log("Send Message : "+JSON.stringify(get_message_data())),messenger.send_message(get_message_data())):console.log("Cannot send message, connection not established")})});