/*! phpIM 26-05-2013 */
var AJAX_DATA_TYPE="json",AJAX_TIMEOUT_MILLISECONDS=6e4,ROOT="/phpIM/index.php/",MANAGER_CHECK_JOINED_TIMEOUT=5e3;"function"!=typeof Object.prototype.create&&(Object.create=function(e){var n=function(){};return n.prototype=e,new n});var mixin_observer_publisher=function(e){var n=[];return e.subscribe=function(e){n.push(e)},e.unsubscribe=function(e){var s;for(s=0;n.length>s;s+=1)if(n[s]===e)return n.splice(s,1),!0;return!1},e.publish=function(e){var s;for(s=0;n.length>s;s+=1)n[s].update(e)},e},new_base_messenger=function(e,n){var s={};return n.isConnected=!1,n.messageQueue=[],n.isMessagePending=!1,n.updateTimeoutTime=e.updateTimeoutTime||0,n.ajax_fig=function(t){var o,a={cache:!1,timeout:AJAX_TIMEOUT_MILLISECONDS,dataType:AJAX_DATA_TYPE,error:function(){var s=0,t=e.maxErrors||3;return function(e,o,a){console.log("ERROR #"+s+" : "+o+" : "+a+"\n"),s+=1,s>t&&(n.isConnected=!1)}}(),complete:function(e,t){console.log("COMPLETE : "+t+"\n"),n.messageQueue.length>0&&s.send(n.messageQueue)}};for(o in t)a[o]=t[o];return a},n.build_update_url=function(e){return ROOT+"conversations/updates/"+JSON.stringify(e)},s},new_messenger=function(e,n){e=e||{},n=n||{};var s,t,o=new_base_messenger(e,n),a=e.ajax||$.ajax,i=function(){n.isConnected&&(console.log("Update Url : "+n.build_update_url([{id:s,last_id:t}])+"\n"),a(n.ajax_fig({url:n.build_update_url([{id:s,last_id:t}]),type:"GET",dataType:"text",success:function(e){console.log("Update Response : "+JSON.stringify(e)+"\n"),n.updateTimeoutTime>0?setTimeout(i,n.updateTimeoutTime):i()},complete:void 0})))};return mixin_observer_publisher(o),o.get_conversation_id=function(){return s},o.connect=function(e){console.log("Connect Data : "+JSON.stringify(e)+"\n"),n.isConnected||(n.isConnected=!0,a(n.ajax_fig({url:ROOT+"conversations",type:"POST",data:e,success:function(e){console.log("Connect Response : "+JSON.stringify(e)+"\n"),s=e.id,i()}})))},o.disconnect=function(){n.isConnected=!1},o.send_message=function(e){var o;n.isConnected&&s&&!n.isMessagePending?(e.conversation_id=s,n.messageQueue.push(e),o=n.messageQueue,console.log("Send Message Data : "+JSON.stringify(o)+"\n"),n.messageQueue=[],n.isMessagePending=!0,a(n.ajax_fig({url:ROOT+"conversations/messages",type:"POST",data:{messages:o},success:function(e){console.log("Send Message Response : "+JSON.stringify(e)+"\n"),t=e.id,n.isMessagePending=!1}}))):(console.log("Could Not send Message\n"),n.messageQueue.push(e))},o},get_message_data=function(){return{message:$('#phpIM-send-message [name="message"]').val()}},get_connect_data=function(){return{username:$('#phpIM-connect [name="username"]').val()}},append_message=function(e){$("#phpIM-message-area").append("<p>"+JSON.stringify(e)+"</p>")},messenger=new_messenger();$(document).ready(function(){$("#phpIM-disconnect").click(function(e){e.preventDefault(),console.log("Disconnect\n"),messenger.disconnect()}),$("#phpIM-connect").submit(function(e){e.preventDefault(),messenger.connect(get_connect_data())}),$("#phpIM-send-message").submit(function(e){e.preventDefault(),console.log("Send Message : "+JSON.stringify(get_message_data())+"\n"),messenger.send_message(get_message_data())})});