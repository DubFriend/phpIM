/*! phpIM 06-07-2013 */
var AJAX_DATA_TYPE="json",AJAX_TIMEOUT_MILLISECONDS=6e4,ROOT="/phpIM/index.php/",MANAGER_CHECK_JOINED_TIMEOUT=1e4;"function"!=typeof Object.prototype.create&&(Object.create=function(e){var n=function(){};return n.prototype=e,new n});var is_array=function(e){return"[object Array]"===Object.prototype.toString.call(e)},array_last=function(e){if(is_array(e))return e.length>0?e[e.length-1]:void 0;throw"not an array"},object_values=function(e){var n,s=[];for(n in e)e.hasOwnProperty(n)&&s.push(e[n]);return s},mixin_observer_publisher=function(e){var n=[];return e.subscribe=function(e){n.push(e)},e.unsubscribe=function(e){var s;for(s=0;n.length>s;s+=1)if(n[s]===e)return n.splice(s,1),!0;return!1},e.publish=function(e){var s;for(s=0;n.length>s;s+=1)n[s].update(e)},e},new_base_messenger=function(e,n){var s={};return n.isConnected=!1,n.messageQueue=[],n.isMessagePending=!1,n.updateTimeoutTime=e.updateTimeoutTime||0,n.ajax_fig=function(t){var a,o={cache:!1,timeout:AJAX_TIMEOUT_MILLISECONDS,dataType:AJAX_DATA_TYPE,error:function(){var s=0,t=e.maxErrors||3;return function(e,a,o){console.log("ERROR #"+s+" : "+a+" : "+o+"\n"),s+=1,s>t&&(n.isConnected=!1)}}(),complete:function(e,t){console.log("COMPLETE : "+t+"\n"),n.messageQueue.length>0&&s.send(n.messageQueue)}};for(a in t)o[a]=t[a];return o},n.build_update_url=function(e){return ROOT+"conversations/updates/"+JSON.stringify(e)},s},new_messenger_view=function(){var e={},n='<h3>{{conversationId}}</h3>{{#messages}}<div class="message"><p>{{message}}</p><p>{{id}}</p><p>{{time_stamp}}</p></div>{{/messages}}';return e.update=function(e){console.log("View Data : "+JSON.stringify(e));var s,t=e.messages;if(t)for(s in t)t[s]instanceof Array&&$("#phpIM-message-area").append(Mustache.render(n,{conversationId:s,messages:t[s]}))},e},new_messenger=function(e,n){e=e||{},n=n||{};var s,t,a=new_base_messenger(e,n),o=e.ajax||$.ajax,i=function(){n.isConnected&&(console.log("Update Url : "+n.build_update_url([{id:s,last_id:t}])+"\n"),o(n.ajax_fig({url:n.build_update_url([{id:s,last_id:t}]),type:"GET",success:function(e){console.log("Update Response : "+JSON.stringify(e)+"\n"),a.publish({messages:e}),e[s]&&(t=array_last(e[s]).id),n.updateTimeoutTime>0?setTimeout(i,n.updateTimeoutTime):i()},complete:void 0})))};return mixin_observer_publisher(a),a.get_conversation_id=function(){return s},a.connect=function(e){console.log("Connect Data : "+JSON.stringify(e)+"\n"),n.isConnected||(n.isConnected=!0,o(n.ajax_fig({url:ROOT+"conversations",type:"POST",data:e,success:function(e){console.log("Connect Response : "+JSON.stringify(e)+"\n"),s=e.id,i()}})))},a.disconnect=function(){n.isConnected=!1},a.send_message=function(e){var a;n.isConnected&&s&&!n.isMessagePending?(e.conversation_id=s,n.messageQueue.push(e),a=n.messageQueue,console.log("Send Message Data : "+JSON.stringify(a)+"\n"),n.messageQueue=[],n.isMessagePending=!0,o(n.ajax_fig({url:ROOT+"conversations/messages",type:"POST",data:{messages:a},success:function(e){console.log("Send Message Response : "+JSON.stringify(e)+"\n"),t=e.id,n.isMessagePending=!1}}))):(console.log("Could Not send Message\n"),n.messageQueue.push(e))},a},get_message_data=function(){return{message:$('#phpIM-send-message [name="message"]').val()}},get_connect_data=function(){return{username:$('#phpIM-connect [name="username"]').val()}},append_message=function(e){$("#phpIM-message-area").append("<p>"+JSON.stringify(e)+"</p>")},messenger=new_messenger(),messageView=new_messenger_view();messenger.subscribe(messageView),$(document).ready(function(){$("#phpIM-disconnect").click(function(e){e.preventDefault(),console.log("Disconnect\n"),messenger.disconnect()}),$("#phpIM-connect").submit(function(e){e.preventDefault(),messenger.connect(get_connect_data())}),$("#phpIM-send-message").submit(function(e){e.preventDefault(),console.log("Send Message : "+JSON.stringify(get_message_data())+"\n"),messenger.send_message(get_message_data())})});