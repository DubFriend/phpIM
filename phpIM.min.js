/*! phpIM 18-05-2013 */
var AJAX_DATA_TYPE="json",AJAX_TIMEOUT_MILLISECONDS=6e4,ROOT="/phpIM/index.php/";"function"!=typeof Object.prototype.create&&(Object.create=function(e){var n=function(){};return n.prototype=e,new n});var mixin_observer_publisher=function(e){var n=[];return e.subscribe=function(e){n.push(e)},e.unsubscribe=function(e){var s;for(s=0;n.length>s;s+=1)if(n[s]===e)return n.splice(s,1),!0;return!1},e.publish=function(e){var s;for(s=0;n.length>s;s+=1)n[s].update(e)},e},new_base_messenger=function(e,n){var s={};return n.isConnected=!1,n.messageQueue=[],n.isMessagePending=!1,n.updateTimeoutTime=e.updateTimeoutTime||0,n.ajax_fig=function(t){var o,i={cache:!1,timeout:AJAX_TIMEOUT_MILLISECONDS,dataType:AJAX_DATA_TYPE,error:function(){var s=0,t=e.maxErrors||3;return function(e,o,i){console.log("ERROR #"+s+" : "+o+" : "+i),s+=1,s>t&&(n.isConnected=!1)}}(),complete:function(e,t){console.log("COMPLETE : "+t),n.messageQueue.length>0&&s.send(n.messageQueue)}};for(o in t)i[o]=t[o];return i},n.build_update_url=function(e){var n=ROOT+"conversations/updates/";return n+=JSON.stringify(e)},s},new_messenger=function(e,n){e=e||{},n=n||{};var s,t,o=new_base_messenger(e,n),i=e.ajax||$.ajax,a=function(){n.isConnected&&(console.log("update url : "+n.build_update_url([{id:s,last_id:t}])),console.log("lastId : "+t),i(n.ajax_fig({url:n.build_update_url([{id:s,last_id:t}]),type:"GET",dataType:"text",success:function(e){console.log("UPDATE RESPONSE : "+JSON.stringify(e)),n.updateTimeoutTime>0?setTimeout(a,n.updateTimeoutTime):a()},complete:void 0})))};return mixin_observer_publisher(o),o.get_conversation_id=function(){return s},o.connect=function(e){n.isConnected||(n.isConnected=!0,i(n.ajax_fig({url:ROOT+"conversations",type:"POST",data:e,success:function(e){console.log("CONNECT RESPONSE : "+JSON.stringify(e)),s=e.id,a()}})))},o.disconnect=function(){n.isConnected=!1},o.send_message=function(e){var o;n.isConnected&&s&&!n.isMessagePending?(console.log("Message Sending"),e.conversation_id=s,n.messageQueue.push(e),o=n.messageQueue,console.log("Message Data : "+JSON.stringify(o)),n.messageQueue=[],n.isMessagePending=!0,console.log(JSON.stringify(o)),i(n.ajax_fig({url:ROOT+"conversations/messages",type:"POST",data:{messages:o},success:function(e){t=e.id,n.isMessagePending=!1,console.log("MESSAGE RESPONSE : "+JSON.stringify(e)),console.log("Message REsponse Id : "+JSON.stringify(e.id))}}))):(console.log("Could Not send Message"),n.messageQueue.push(e))},o},get_message_data=function(){return{message:$('#phpIM-send-message [name="message"]').val()}},get_connect_data=function(){return{username:$('phpIM-connect [name="username"]').val()}},append_message=function(e){$("#phpIM-message-area").append("<p>"+JSON.stringify(e)+"</p>")},messenger=new_messenger();$(document).ready(function(){$("#phpIM-disconnect").click(function(e){e.preventDefault(),console.log("Disconnect"),messenger.disconnect()}),$("#phpIM-connect").submit(function(e){e.preventDefault(),messenger.connect(get_connect_data())}),$("#phpIM-send-message").submit(function(e){e.preventDefault(),console.log("Send Message : "+JSON.stringify(get_message_data())),messenger.send_message(get_message_data())})});