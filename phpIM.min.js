/*! phpIM 16-05-2013 */
var AJAX_DATA_TYPE="json",AJAX_TIMEOUT_MILLISECONDS=6e4,ROOT="/phpIM/index.php/";"function"!=typeof Object.prototype.create&&(Object.create=function(e){var n=function(){};return n.prototype=e,new n});var mixin_observer_publisher=function(e){var n=[];return e.subscribe=function(e){n.push(e)},e.unsubscribe=function(e){var s;for(s=0;n.length>s;s+=1)if(n[s]===e)return n.splice(s,1),!0;return!1},e.publish=function(e){var s;for(s=0;n.length>s;s+=1)n[s].update(e)},e},new_messenger=function(e){e=e||{};var n,s,t={},o=e.ajax||$.ajax,c=[],i=!1,r=!1,a=0,u=e.maxErrors||3,g=e.updateTimeoutTime||0,p=function(e){var n,s={cache:!1,timeout:AJAX_TIMEOUT_MILLISECONDS,dataType:AJAX_DATA_TYPE,error:function(e,n,s){console.log("ERROR #"+a+" : "+n+" : "+s),a+=1,a>u&&(i=!1)},complete:function(e,n){console.log("COMPLETE : "+n),isMessageSendPending=!1,c.length>0&&t.send(c)}};for(n in e)s[n]=e[n];return s},f=function(){if(i){var e;e=s?ROOT+"conversations/"+n+"/messages_since/"+s:ROOT+"conversations/"+n,o(p({url:e,type:"GET",success:function(e){console.log("UPDATE RESPONSE : "+JSON.stringify(e)),g>0?setTimeout(f,g):f()},complete:void 0}))}};return mixin_observer_publisher(t),t.is_connected=function(){return i},t.is_message_pending=function(){return r},t.message_queue_length=function(){return c.length},t.id=function(){return n},t.connect=function(e){i=!0,o(p({url:ROOT+"conversations",type:"POST",data:e,success:function(e){console.log("CONNECT RESPONSE : "+JSON.stringify(e)),n=e.id,f()}}))},t.disconnect=function(){i=!1},t.send_message=function(e){var t;i&&n&&!r?(console.log("Message Sending"),c.length>0?(c.push(e),t=c):t=e,c=[],r=!0,o(p({url:ROOT+"conversations/"+n+"/messages",type:"POST",data:t,success:function(e){s=e.id,r=!1,console.log("MESSAGE RESPONSE : "+JSON.stringify(e))}}))):(console.log("Could Not send Message"),c.push(e))},t},get_message_data=function(){return{message:$('#phpIM-send-message [name="message"]').val()}},get_connect_data=function(){return{username:$('phpIM-connect [name="username"]').val()}},append_message=function(e){$("#phpIM-message-area").append("<p>"+JSON.stringify(e)+"</p>")},messenger=new_messenger();$(document).ready(function(){$("#phpIM-disconnect").click(function(e){e.preventDefault(),console.log("Disconnect"),messenger.disconnect()}),$("#phpIM-connect").submit(function(e){e.preventDefault(),messenger.connect(get_connect_data())}),$("#phpIM-send-message").submit(function(e){e.preventDefault(),messenger.is_connected()?(console.log("Send Message : "+JSON.stringify(get_message_data())),messenger.send_message(get_message_data())):console.log("Cannot send message, connection not established")})});