/*! phpIM 12-05-2013 */
var AJAX_DATA_TYPE="json",AJAX_TIMEOUT_MILLISECONDS=6e4,ROOT="/phpIM/index.php/";"function"!=typeof Object.prototype.create&&(Object.create=function(e){var n=function(){};return n.prototype=e,new n});var new_messenger=function(e){e=e||{};var n,t={},s=e.ajax||$.ajax,o=[],c=!1,a=!1,i=0,r=e.maxErrors||3,u=e.updateTimeoutTime||0,g=function(e){var n,s={cache:!1,timeout:AJAX_TIMEOUT_MILLISECONDS,dataType:AJAX_DATA_TYPE,error:function(e,n,t){console.log("ERROR #"+i+" : "+n+" : "+t),i+=1,i>r&&(c=!1)},complete:function(e,n){console.log("COMPLETE : "+n),isMessageSendPending=!1,o.length>0&&t.send(o)}};for(n in e)s[n]=e[n];return s},p=function(){c&&s(g({url:ROOT+"conversations/"+n,type:"GET",success:function(e){console.log("CONNECT RESPONSE : "+JSON.stringify(e)),u>0?setTimeout(p,u):p()},complete:void 0}))};return t.is_connected=function(){return c},t.is_message_pending=function(){return a},t.message_queue_length=function(){return o.length},t.id=function(){return n},t.connect=function(e){c=!0,s(g({url:ROOT+"conversations",type:"POST",data:e,success:function(e){console.log("CONNECT RESPONSE : "+JSON.stringify(e)),n=e.id,p()}}))},t.disconnect=function(){c=!1},t.send_message=function(e){var t;c&&n&&!a?(o.length>0?(o.push(e),t=o):t=e,o=[],a=!0,s(g({url:ROOT+"conversations/"+n+"/messages",type:"POST",data:t,success:function(e){a=!1,console.log("MESSAGE RESPONSE : "+JSON.stringify(e))}}))):o.push(e)},t},get_message_data=function(){return{message:$('#phpIM-send-message [name="message"]').val()}},get_connect_data=function(){return{username:$('phpIM-connect [name="username"]').val()}},append_message=function(e){$("#phpIM-message-area").append("<p>"+JSON.stringify(e)+"</p>")},messenger=new_messenger();$(document).ready(function(){$("#phpIM-disconnect").click(function(e){e.preventDefault(),messenger.disconnect()}),$("#phpIM-connect").submit(function(e){e.preventDefault(),messenger.connect(get_connect_data())}),$("#phpIM-send-message").submit(function(e){e.preventDefault(),messenger.is_connected()?messenger.send(get_message_data()):console.log("Cannot send message, connection not established")})});